<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — Learn Python</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="page-header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">Py</div>
        <div>
          <h1>Progress Dashboard</h1>
          <p class="lead">Per-user progress and quiz stats</p>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px;">
        <nav class="mini-nav" aria-label="Main navigation">
          <a href="lessons.html" class="mini-nav-link">Lessons</a>
          <a href="questions.html" class="mini-nav-link">Quizzes</a>
          <a href="dashboard.html" class="mini-nav-link" aria-current="page">Dashboard</a>
          <a href="playground.html" class="mini-nav-link">Playground</a>
        </nav>

        <div id="profileWidget"></div>
      </div>
    </div>
  </header>

  <main class="dashboard-grid container">
    <section class="left card">
      <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:14px;">
        <div>
          <button id="resetProgress" class="btn ghost">Reset Progress</button>
          <button id="resetStats" class="btn ghost">Reset Quiz Stats</button>
        </div>
        <div>
          <button id="exportBtn" class="btn">Export Progress</button>
          <label class="btn ghost" style="cursor:pointer">
            Import
            <input id="importFile" type="file" accept=".json" style="display:none" />
          </label>
        </div>
      </div>

      <h3>Lessons</h3>
      <div id="lessonsList" class="lessons-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px"></div>
    </section>

    <aside class="right card">
      <h3>Summary</h3>
      <div id="summaryArea"></div>
      <hr style="margin:12px 0" />
      <h4>Quiz Breakdown</h4>
      <div id="quizBreakdown"></div>
    </aside>
  </main>

  <script src="app.js"></script>
  <script>
    window.learnApp.renderHeaderProfile('#profileWidget');

    async function loadLessons() {
      const res = await fetch('lessons.json'); return res.json();
    }

    (async function init() {
      const lessons = await loadLessons();
      const profile = window.learnApp.getCurrentProfile();
      const userId = (profile && profile.id) ? profile.id : 'user_guest';

      const list = document.getElementById('lessonsList');
      list.innerHTML = '';
      const progress = window.learnApp.getUserProgress(userId);
      lessons.forEach(l => {
        const div = document.createElement('div');
        div.className = 'lesson-card';
        const done = !!progress[l.id];
        div.innerHTML = `
          <h4 style="margin:4px 0">${l.title}</h4>
          <div class="small" style="color:var(--muted)">${l.category}</div>
          <p style="margin-top:10px">${done ? '✅ Completed' : '⚪ Not completed'}</p>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <a class="btn ghost" href="lessons.html#lesson-${l.id}">Open</a>
          </div>
        `;
        list.appendChild(div);
      });

      const total = lessons.length;
      const completedCount = Object.values(progress).filter(v => v === true).length;
      document.getElementById('summaryArea').innerHTML = `
        <p><strong>${completedCount}</strong> / ${total} lessons completed</p>
        <div class="progress-bar"><div class="progress-fill" style="width:${Math.round((completedCount/total)*100)}%"></div></div>
      `;

      const stats = window.learnApp.getUserQuizStats(userId);
      const breakdown = document.getElementById('quizBreakdown');
      if (!stats || Object.keys(stats).length === 0) {
        breakdown.innerHTML = '<p class="small">No quiz data yet</p>';
      } else {
        const rows = [];
        for (const k in stats) {
          const s = stats[k];
          const avg = s.scores.length ? Math.round(s.scores.reduce((a,b)=>a+b,0)/s.scores.length) : 0;
          const best = s.scores.length ? Math.max(...s.scores) : 0;
          rows.push(`<div style="margin-bottom:10px"><strong>${k}</strong><div class="small">Attempts: ${s.attempts} • Avg: ${avg}% • Best: ${best}%</div></div>`);
        }
        breakdown.innerHTML = rows.join('');
      }

      document.getElementById('exportBtn').addEventListener('click', () => {
        const prof = window.learnApp.getCurrentProfile();
        const id = prof && prof.id ? prof.id : 'user_guest';
        window.learnApp.exportUserData(id, `${(prof.name||'progress')}-${id}.json`);
      });

      document.getElementById('importFile').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          await window.learnApp.importUserDataFromFile(file);
          window.learnApp.renderHeaderProfile('#profileWidget');
          location.reload();
        } catch (err) {
          alert('Import failed: ' + (err.message || err));
        }
      });

      document.getElementById('resetProgress').addEventListener('click', () => {
        if (!confirm('Reset lesson progress for this profile?')) return;
        window.learnApp.saveUserProgress(userId, {});
        location.reload();
      });
      document.getElementById('resetStats').addEventListener('click', () => {
        if (!confirm('Reset quiz stats for this profile?')) return;
        window.learnApp.saveUserQuizStats(userId, {});
        location.reload();
      });
    })();
  </script>
</body>
</html>
