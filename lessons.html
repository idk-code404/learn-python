<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lessons â€” Learn Python</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* page-specific fine-tuning */
    #lessons-wrapper { display:flex; gap:20px; max-width:1200px; margin:20px auto; padding:0 20px; align-items:flex-start; }
    #toc { width:260px; padding:14px; }
    #lessons { flex:1; min-width:0; }
    .lesson pre { white-space:pre-wrap; word-break:break-word; }
  </style>
</head>
<body>
  <header class="page-header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">Py</div>
        <div>
          <h1>Learn Python</h1>
          <p class="lead">Lessons â€” Beginner â†’ Expert</p>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px;">
        <nav class="mini-nav" aria-label="Main navigation">
          <a href="lessons.html" class="mini-nav-link" aria-current="page">Lessons</a>
          <a href="questions.html" class="mini-nav-link">Quizzes</a>
          <a href="dashboard.html" class="mini-nav-link">Dashboard</a>
          <a href="playground.html" class="mini-nav-link">Playground</a>
        </nav>

        <div id="profileWidget"></div>
      </div>
    </div>
  </header>

  <div id="lessons-wrapper">
    <aside id="toc" class="card">
      <h2>Table of Contents</h2>
      <ul id="toc-list"></ul>

      <div id="toc-tips" style="margin-top:12px;">
        <h3>ðŸ’¡ Quick Tips</h3>
        <ul style="padding-left:12px; margin-top:8px;">
          <li>Use 4 spaces for indentation (PEP8).</li>
          <li>Use descriptive variable names.</li>
          <li>Read error traces â€” they point to the line that failed.</li>
          <li>Try small changes in the playground.</li>
        </ul>
      </div>
    </aside>

    <main id="lessons" role="main" aria-live="polite"></main>
  </div>

  <script src="app.js"></script>
  <script>
    window.learnApp.renderHeaderProfile('#profileWidget');

    async function fetchLessons() {
      const r = await fetch('lessons.json');
      return r.json();
    }

    (async function render() {
      const lessonsMain = document.getElementById('lessons');
      const tocList = document.getElementById('toc-list');
      const lessons = await fetchLessons();
      const order = ['Beginner','Intermediate','Advanced','Expert'];
      const grouped = {};
      order.forEach(o => grouped[o] = []);
      lessons.forEach(l => {
        const cat = l.category || 'Uncategorized';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(l);
      });

      const profile = window.learnApp.getCurrentProfile();
      const userId = profile && profile.id ? profile.id : 'user_guest';
      const progress = window.learnApp.getUserProgress(userId);

      for (const cat of order) {
        if (!grouped[cat] || grouped[cat].length === 0) continue;
        const sec = document.createElement('section');
        sec.className = 'category card';
        sec.id = `cat-${cat.toLowerCase()}`;
        sec.innerHTML = `<h2>${cat}</h2>`;
        const listDiv = document.createElement('div');

        grouped[cat].forEach(lesson => {
          const lessonDiv = document.createElement('article');
          lessonDiv.className = 'lesson';
          lessonDiv.id = `lesson-${lesson.id}`;

          const done = !!progress[lesson.id];
          lessonDiv.innerHTML = `
            <h3>${lesson.title}</h3>
            <p class="small">${lesson.content || ''}</p>
            <pre><code>${escapeHtml(lesson.code || '')}</code></pre>
            <div class="actions">
              <button class="btn try-btn">â–¶ Try Code</button>
              <a class="btn ghost" href="questions.html?category=${encodeURIComponent(lesson.category)}">Topic Quiz</a>
              <button class="btn ghost mark-complete">${done ? 'Mark Incomplete' : 'Mark Complete'}</button>
              <span class="small status" style="align-self:center">${done ? 'âœ… Completed' : 'âšª Not completed'}</span>
            </div>
          `;

          // actions
          const tryBtn = lessonDiv.querySelector('.try-btn');
          tryBtn.addEventListener('click', async () => {
            const codeText = lesson.code || '';
            let newTab = null;
            try { newTab = window.open('', '_blank'); } catch(e) { newTab = null; }
            try { await navigator.clipboard.writeText(codeText); } catch (e) { /* ignore */ }
            const url = `playground.html?code=${encodeURIComponent(codeText)}`;
            if (newTab) newTab.location = url;
            else window.open(url, '_blank');
            window.learnApp.showToast && window.learnApp.showToast('Copied code and opened playground');
          });

          const markBtn = lessonDiv.querySelector('.mark-complete');
          markBtn.addEventListener('click', () => {
            const prog = window.learnApp.getUserProgress(userId);
            if (prog[lesson.id]) {
              delete prog[lesson.id];
              markBtn.textContent = 'Mark Complete';
              lessonDiv.querySelector('.status').textContent = 'âšª Not completed';
            } else {
              prog[lesson.id] = true;
              markBtn.textContent = 'Mark Incomplete';
              lessonDiv.querySelector('.status').textContent = 'âœ… Completed';
            }
            window.learnApp.saveUserProgress(userId, prog);
          });

          listDiv.appendChild(lessonDiv);
        });

        sec.appendChild(listDiv);
        lessonsMain.appendChild(sec);

        // TOC
        const li = document.createElement('li');
        li.innerHTML = `<a href="#cat-${cat.toLowerCase()}">${cat}</a>`;
        tocList.appendChild(li);
      }

      // scroll-spy
      const links = document.querySelectorAll('#toc a');
      const sections = document.querySelectorAll('.category');
      function spy() {
        let id = '';
        sections.forEach(s => {
          const rect = s.getBoundingClientRect();
          if (rect.top <= 140) id = s.id;
        });
        links.forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#' + id));
      }
      document.addEventListener('scroll', spy, { passive: true });
      spy();

      // deep-link to lesson if hash present
      if (location.hash && location.hash.startsWith('#lesson-')) {
        const target = document.querySelector(location.hash);
        if (target) setTimeout(()=> target.scrollIntoView({behavior:'smooth', block:'start'}), 100);
      }
    })();

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
