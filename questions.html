<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quizzes ‚Äî Learn Python</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .quiz-wrap { max-width:900px; margin:24px auto; padding:0 16px; }
    .quiz-levels { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-bottom:18px; }
    .quiz-panel { background:var(--card-bg); padding:16px; border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
    .options { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .progress-inline { height:10px; background:#eee; border-radius:6px; overflow:hidden; }
    .progress-fill { height:100%; background:var(--accent); width:0%; transition:width .3s; }
  </style>
</head>
<body>
  <header class="page-header">
    <div class="header-inner">
      <div class="brand"><h1>üß† Quizzes</h1><p class="lead">Pick a level and test your knowledge</p></div>
      <nav class="mini-nav" aria-label="Main navigation">
        <a href="lessons.html" class="mini-nav-link">Lessons</a>
        <a href="questions.html" class="mini-nav-link" aria-current="page">Quizzes</a>
        <a href="dashboard.html" class="mini-nav-link">Dashboard</a>
        <a href="playground.html" class="mini-nav-link">Playground</a>
      </nav>
    </div>
  </header>

  <main class="quiz-wrap">
    <div class="quiz-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
        <div>
          <h2 style="margin:0">Choose difficulty</h2>
          <p class="small" style="margin:6px 0 0 0">Select which category of lessons the quiz should draw from.</p>
        </div>
        <div>
          <label class="small">Questions:
            <select id="numQuestions"><option>5</option><option selected>10</option><option>15</option></select>
          </label>
        </div>
      </div>

      <div class="quiz-levels" style="margin-top:14px;">
        <button class="btn" onclick="startQuiz('Beginner')">Beginner</button>
        <button class="btn" onclick="startQuiz('Intermediate')">Intermediate</button>
        <button class="btn" onclick="startQuiz('Advanced')">Advanced</button>
        <button class="btn" onclick="startQuiz('Expert')">Expert</button>
      </div>
    </div>

    <div id="quizArea" style="display:none;margin-top:18px;">
      <div class="quiz-panel">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong id="quizHeader">Quiz</strong>
          <div style="min-width:220px;">
            <div class="progress-inline" aria-hidden="true"><div id="qProgress" class="progress-fill"></div></div>
            <div class="small" id="qMeta" style="text-align:right;margin-top:6px"></div>
          </div>
        </div>

        <h3 id="questionText" style="margin-top:14px"></h3>
        <div id="options" class="options"></div>

        <div style="display:flex;gap:8px;margin-top:14px;justify-content:flex-end;">
          <button id="prevBtn" class="btn" style="display:none">Previous</button>
          <button id="nextBtn" class="btn">Next</button>
          <button id="endBtn" class="btn" style="display:none">Finish</button>
        </div>
        <p id="feedback" class="small" style="margin-top:10px;color:var(--muted)"></p>
      </div>
    </div>

    <div id="resultArea" style="display:none;margin-top:18px;">
      <div class="quiz-panel">
        <h2 id="resultTitle">Results</h2>
        <p id="resultSummary"></p>
        <div id="detailedAnswers" style="margin-top:12px"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
          <button class="btn" onclick="location.reload()">Back</button>
          <a id="reviewLessons" class="btn" href="lessons.html">Open Lessons</a>
        </div>
      </div>
    </div>
  </main>

  <script>
    let lessons = [];
    let quizQuestions = [];
    let answers = []; // user answers
    let currentIdx = 0;
    let selectedLevel = '';
    const qArea = document.getElementById('quizArea');
    const resultArea = document.getElementById('resultArea');

    async function loadLessonsIfNeeded() {
      if (lessons.length) return;
      const res = await fetch('lessons.json');
      lessons = await res.json();
    }

    async function startQuiz(level) {
      await loadLessonsIfNeeded();
      selectedLevel = level;
      const available = lessons.filter(l => l.category === level && l.quiz);
      if (available.length === 0) {
        alert('No questions available for this level.');
        return;
      }
      const num = parseInt(document.getElementById('numQuestions').value, 10) || 10;
      // pick randomized set (max available)
      const shuffled = available.sort(() => Math.random() - 0.5);
      const chosen = shuffled.slice(0, Math.min(num, shuffled.length));
      quizQuestions = chosen.map(l => ({
        question: l.quiz.question,
        options: l.quiz.options.slice(), // copy
        answer: l.quiz.answer,
        title: l.title,
        lessonId: l.id
      }));
      answers = Array(quizQuestions.length).fill(null);
      currentIdx = 0;
      renderQuestion();
      qArea.style.display = 'block';
      resultArea.style.display = 'none';
      document.getElementById('quizHeader').textContent = `${level} Quiz`;
      updateProgressUI();
    }

    function renderQuestion() {
      const q = quizQuestions[currentIdx];
      if (!q) return;
      document.getElementById('questionText').textContent = q.question;
      const opts = document.getElementById('options');
      opts.innerHTML = '';
      // shuffle options for display
      const shuffledOptions = q.options.sort(() => Math.random() - 0.5);
      shuffledOptions.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        btn.onclick = () => selectOption(opt, q);
        if (answers[currentIdx] !== null) btn.disabled = true;
        opts.appendChild(btn);
      });
      document.getElementById('feedback').textContent = answers[currentIdx] ? (answers[currentIdx] === q.answer ? '‚úÖ Correct' : `‚ùå Was: ${q.answer}`) : '';
      // Prev/Next/End buttons
      document.getElementById('prevBtn').style.display = currentIdx > 0 ? 'inline-flex' : 'none';
      document.getElementById('nextBtn').style.display = currentIdx < quizQuestions.length - 1 ? 'inline-flex' : 'none';
      document.getElementById('endBtn').style.display = currentIdx === quizQuestions.length - 1 ? 'inline-flex' : 'none';
      document.getElementById('qMeta').textContent = `Question ${currentIdx + 1} / ${quizQuestions.length}`;
      updateProgressUI();
    }

    function selectOption(opt, q) {
      answers[currentIdx] = opt;
      // disable option buttons
      document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
      // show feedback
      const fb = document.getElementById('feedback');
      if (opt === q.answer) fb.textContent = '‚úÖ Correct ‚Äî well done!';
      else fb.textContent = `‚ùå Incorrect ‚Äî correct: ${q.answer}`;
    }

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentIdx < quizQuestions.length - 1) currentIdx++;
      renderQuestion();
    });
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentIdx > 0) currentIdx--;
      renderQuestion();
    });
    document.getElementById('endBtn').addEventListener('click', finishQuiz);

    function updateProgressUI() {
      const pct = Math.round((currentIdx / Math.max(1, quizQuestions.length - 1)) * 100);
      document.getElementById('qProgress').style.width = `${pct}%`;
    }

    function finishQuiz() {
      // compute score
      let correct = 0;
      const details = [];
      quizQuestions.forEach((q, i) => {
        const user = answers[i];
        const ok = user === q.answer;
        if (ok) correct++;
        details.push({ idx: i+1, title: q.title, question: q.question, chosen: user, answer: q.answer, ok });
      });

      const percent = Math.round((correct / quizQuestions.length) * 100);
      // save per-category stats
      const stats = JSON.parse(localStorage.getItem('quizStats')) || {};
      if (!stats[selectedLevel]) stats[selectedLevel] = { attempts: 0, scores: [] };
      stats[selectedLevel].attempts++;
      stats[selectedLevel].scores.push(percent);
      localStorage.setItem('quizStats', JSON.stringify(stats));

      // Optionally mark per-lesson progress for correctly answered items
      const progress = JSON.parse(localStorage.getItem('progress')) || {};
      details.forEach(d => {
        if (d.ok && d.lessonId) {
          progress[d.lessonId] = true;
        }
      });
      localStorage.setItem('progress', JSON.stringify(progress));

      // render result
      document.getElementById('resultTitle').textContent = `${selectedLevel} Quiz ‚Äî Results`;
      document.getElementById('resultSummary').textContent = `You scored ${percent}% ‚Äî ${correct} / ${quizQuestions.length} correct.`;
      const detailsDiv = document.getElementById('detailedAnswers');
      detailsDiv.innerHTML = details.map(d => `
        <div style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);margin-bottom:8px;">
          <strong>Q${d.idx} ‚Äî ${d.title}</strong>
          <div class="small" style="margin-top:6px">${d.question}</div>
          <div style="margin-top:8px">Your answer: <strong>${d.chosen || '‚Äî'}</strong> ${d.ok? '‚úÖ' : '‚ùå'}</div>
          ${d.ok ? '' : `<div style="margin-top:6px">Correct answer: <strong>${d.answer}</strong></div>`}
        </div>
      `).join('');
      qArea.style.display = 'none';
      resultArea.style.display = 'block';
    }

    // support preselect category via ?category= in URL
    (function preselectFromQuery() {
      const params = new URLSearchParams(location.search);
      const cat = params.get('category');
      if (cat) {
        // delay a bit to allow UI to settle
        setTimeout(()=> startQuiz(cat), 180);
      }
    })();
  </script>
</body>
</html>
