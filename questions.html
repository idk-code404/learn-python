<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quizzes — Learn Python</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="page-header">
    <div class="header-inner">
      <div class="brand">
        <h1>🧠 Quizzes</h1>
        <p class="lead">Pick a level and measure your progress</p>
      </div>

      <div style="display:flex;align-items:center;gap:12px;">
        <nav class="mini-nav" aria-label="Main navigation">
          <a href="lessons.html" class="mini-nav-link">Lessons</a>
          <a href="questions.html" class="mini-nav-link" aria-current="page">Quizzes</a>
          <a href="dashboard.html" class="mini-nav-link">Dashboard</a>
          <a href="playground.html" class="mini-nav-link">Playground</a>
        </nav>

        <div id="profileWidget"></div>
      </div>
    </div>
  </header>

  <main class="quiz-wrap">
    <div class="quiz-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
        <div>
          <h2 style="margin:0">Choose a level</h2>
          <p class="small">Select the category to draw questions from.</p>
        </div>
        <div>
          <label class="small">Questions:
            <select id="numQuestions"><option>5</option><option selected>10</option><option>15</option></select>
          </label>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" onclick="startQuiz('Beginner')">Beginner</button>
        <button class="btn" onclick="startQuiz('Intermediate')">Intermediate</button>
        <button class="btn" onclick="startQuiz('Advanced')">Advanced</button>
        <button class="btn" onclick="startQuiz('Expert')">Expert</button>
      </div>
    </div>

    <div id="quizArea" style="display:none;margin-top:18px;"></div>
    <div id="resultArea" style="display:none;margin-top:18px;"></div>
  </main>

  <script src="app.js"></script>
  <script>
    window.learnApp.renderHeaderProfile('#profileWidget');

    let lessons = [];
    let quizQuestions = [];
    let answers = [];
    let current = 0;
    let selectedCategory = '';

    async function loadLessons() {
      if (lessons.length) return lessons;
      const res = await fetch('lessons.json');
      lessons = await res.json();
      return lessons;
    }

    async function startQuiz(category) {
      await loadLessons();
      selectedCategory = category;
      const num = parseInt(document.getElementById('numQuestions').value, 10) || 10;
      const available = lessons.filter(l => l.category === category && l.quiz);
      if (available.length === 0) { alert('No questions for this level'); return; }
      const chosen = available.sort(() => Math.random()-0.5).slice(0, Math.min(num, available.length));
      quizQuestions = chosen.map(l => ({ question: l.quiz.question, options: l.quiz.options.slice(), answer: l.quiz.answer, lessonId: l.id, title: l.title }));
      answers = Array(quizQuestions.length).fill(null);
      current = 0;
      renderQuizArea();
    }

    function renderQuizArea() {
      const qa = document.getElementById('quizArea');
      qa.style.display = 'block';
      qa.innerHTML = `
        <div class="quiz-panel">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>${selectedCategory} Quiz</strong>
            <div style="min-width:200px;">
              <div class="progress-bar"><div id="qFill" class="progress-fill" style="width:0%"></div></div>
              <div class="small" id="qMeta" style="text-align:right;margin-top:6px"></div>
            </div>
          </div>
          <h3 id="qText" style="margin-top:12px"></h3>
          <div id="qOptions" class="options"></div>
          <p id="qFeedback" class="small" style="margin-top:12px"></p>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button id="prevBtn" class="btn ghost" style="display:none">Previous</button>
            <button id="nextBtn" class="btn">Next</button>
            <button id="finishBtn" class="btn" style="display:none">Finish</button>
          </div>
        </div>
      `;
      document.getElementById('nextBtn').addEventListener('click', () => { current++; renderQuestion(); });
      document.getElementById('prevBtn').addEventListener('click', () => { current--; renderQuestion(); });
      document.getElementById('finishBtn').addEventListener('click', finishQuiz);
      renderQuestion();
    }

    function renderQuestion() {
      const q = quizQuestions[current];
      document.getElementById('qText').textContent = q.question;
      const opts = document.getElementById('qOptions'); opts.innerHTML = '';
      const shuffled = q.options.sort(() => Math.random() - 0.5);
      shuffled.forEach(o => {
        const b = document.createElement('button');
        b.className = 'option-btn';
        b.textContent = o;
        b.onclick = () => {
          answers[current] = o;
          // disable buttons
          document.querySelectorAll('.option-btn').forEach(x => x.disabled = true);
          const fb = document.getElementById('qFeedback');
          fb.textContent = o === q.answer ? '✅ Correct!' : `❌ Incorrect — correct: ${q.answer}`;
        };
        opts.appendChild(b);
      });

      // set feedback if already answered
      const fb = document.getElementById('qFeedback');
      fb.textContent = answers[current] ? (answers[current] === q.answer ? '✅ Correct!' : `❌ Incorrect — correct: ${q.answer}`) : '';

      document.getElementById('prevBtn').style.display = current > 0 ? 'inline-flex' : 'none';
      document.getElementById('nextBtn').style.display = current < quizQuestions.length - 1 ? 'inline-flex' : 'none';
      document.getElementById('finishBtn').style.display = current === quizQuestions.length - 1 ? 'inline-flex' : 'none';

      // progress bar
      const pct = Math.round((current / Math.max(1, quizQuestions.length - 1)) * 100);
      document.getElementById('qFill').style.width = pct + '%';
      document.getElementById('qMeta').textContent = `Question ${current + 1} / ${quizQuestions.length}`;
    }

    function finishQuiz() {
      let correct = 0;
      const details = [];
      quizQuestions.forEach((q, i) => {
        const chosen = answers[i];
        const ok = chosen === q.answer;
        if (ok) correct++;
        details.push({ title: q.title, question: q.question, chosen, answer: q.answer, ok, lessonId: q.lessonId });
      });
      const percent = Math.round((correct / quizQuestions.length) * 100);

      // save per-user stats
      const profile = window.learnApp.getCurrentProfile();
      const userId = profile && profile.id ? profile.id : 'user_guest';
      const stats = window.learnApp.getUserQuizStats(userId);
      if (!stats[selectedCategory]) stats[selectedCate]()
